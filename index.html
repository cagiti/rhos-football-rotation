<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Rhos FC Substitution Planner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #001f3f;
      color: #FFDC00;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #FFDC00;
    }

    .badge {
      display: block;
      margin: 0 auto 20px auto;
      height: 100px;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background-color: #002b5c;
      padding: 20px;
      border-radius: 10px;
    }

    label, textarea, input, select {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      font-size: 16px;
      color: #FFDC00;
    }

    textarea {
      height: 140px;
      resize: vertical;
      color: #001f3f;
    }

    input, select {
      padding: 8px;
      background-color: #ffffff;
      border: 1px solid #FFDC00;
      border-radius: 4px;
      color: #001f3f;
    }

    button {
      background-color: #FFDC00;
      color: #001f3f;
      font-weight: bold;
      padding: 10px 15px;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }

    button:hover {
      background-color: #e6c800;
    }

    pre {
      white-space: pre-wrap;
      background: #001933;
      padding: 15px;
      border-radius: 5px;
      color: #ffffff;
    }
  </style>
</head>
<body>

  <h1>Rhos FC Substitution Planner</h1>
  <img class="badge" src="./img/rhos.png" alt="Club Badge">

  <div class="container">
    <label>Players (one per line, format: Name [POS])</label>
    <textarea id="players">Harri [GK]
Billy
Trystan
Ellis
Alf G
Woody
Seth
Tom BT
</textarea>

    <label>Match Duration (minutes):</label>
    <input type="number" id="matchDuration" value="60" />

    <label>Substitution Interval (minutes):</label>
    <input type="number" id="interval" value="5" />

    <label>Players on Pitch (excluding GK):</label>
    <input type="number" id="onPitch" value="6" />

    <label>Players Substituted Per Interval:</label>
    <input type="number" id="subsPerInterval" value="1" />

    <label>Toggle Halfâ€‘Time Pause:</label>
    <select id="halfTime">
      <option value="true">Yes</option>
      <option value="false">No</option>
    </select>

    <button onclick="generateSchedule()">Generate Schedule</button>

    <h2>Output</h2>
    <pre id="output"></pre>
  </div>

  <script>
    function generateSchedule() {
      const playerLines = document.getElementById('players').value.trim().split('\n')
        .map(line => line.trim())
        .filter(line => line !== '');

      const playerPattern = /^(.+?)\s+\[(.+?)\]$/;
      const players = playerLines.map(line => {
        const match = line.match(playerPattern);
        if (match) {
          return { name: match[1].trim(), position: match[2].trim().toUpperCase() };
        } else {
          return { name: line.trim(), position: 'NONE' };
        }
      });

      const matchDuration = parseInt(document.getElementById('matchDuration').value);
      const interval = parseInt(document.getElementById('interval').value);
      const onPitch = parseInt(document.getElementById('onPitch').value);
      const subsPerInterval = parseInt(document.getElementById('subsPerInterval').value);
      const halfTimePause = document.getElementById('halfTime').value === 'true';

      const numIntervals = Math.floor(matchDuration / interval);
      let substitutionTimes = Array.from({ length: numIntervals }, (_, i) => (i + 1) * interval);
      if (substitutionTimes[substitutionTimes.length - 1] === matchDuration) substitutionTimes.pop();
      if (halfTimePause) {
        const half = matchDuration / 2;
        substitutionTimes = substitutionTimes.filter(t => t !== half);
      }

      const timePerPlayer = {};
      players.forEach(p => timePerPlayer[p.name] = 0);

      const gk = players.find(p => p.position === 'GK');
      const outfieldPlayers = players.filter(p => p.position !== 'GK');

      let onField = outfieldPlayers.slice(0, onPitch).map(p => p.name);
      let bench = outfieldPlayers.slice(onPitch).map(p => p.name);

      if (gk) {
        onField.unshift(gk.name);
      }

      onField.forEach(p => {
        timePerPlayer[p] += interval;
      });

      let schedule = '';
      schedule += `Starting Lineup: ${onField.join(', ')}\n\n`;

      substitutionTimes.forEach((time) => {
        const currentOutfield = onField.filter(p => p !== (gk?.name ?? ''));

        const playerMap = name => players.find(p => p.name === name);
        const onFieldWithPos = currentOutfield.map(name => {
          const p = playerMap(name);
          return { name, position: p?.position ?? 'NONE' };
        });

        const benchWithPos = bench.map(name => {
          const p = playerMap(name);
          return { name, position: p?.position ?? 'NONE' };
        });

        const off = [];
        const on = [];

        for (let i = 0; i < subsPerInterval; i++) {
          benchWithPos.sort((a, b) => timePerPlayer[a.name] - timePerPlayer[b.name]);
          let candidateOn = benchWithPos.shift();
          if (!candidateOn) continue;

          let matchOff = onFieldWithPos
            .filter(p => p.position === candidateOn.position)
            .sort((a, b) => timePerPlayer[b.name] - timePerPlayer[a.name])[0];

          if (!matchOff) {
            matchOff = onFieldWithPos.sort((a, b) => timePerPlayer[b.name] - timePerPlayer[a.name])[0];
          }

          if (matchOff) {
            off.push(matchOff.name);
            on.push(candidateOn.name);
            onFieldWithPos.splice(onFieldWithPos.findIndex(p => p.name === matchOff.name), 1);
          }
        }

        bench = bench.filter(n => !on.includes(n)).concat(off);
        onField = onField.filter(n => !off.includes(n)).concat(on);

        onField.forEach(p => {
          timePerPlayer[p] += interval;
        });

        schedule += `Minute ${time}:\n  Off: ${off.join(', ')}\n  On: ${on.join(', ')}\n  Current Lineup: ${onField.join(', ')}\n\n`;
      });

      const lastSubTime = substitutionTimes[substitutionTimes.length - 1] || 0;
      const lastBlock = matchDuration - lastSubTime;
      if (lastBlock > 0) {
        onField.forEach(p => {
          timePerPlayer[p] += lastBlock;
        });
      }

      schedule += `\nFinal Playing Time:\n`;
      players.forEach(p => {
        schedule += `${p.name} [${p.position}]: ${timePerPlayer[p.name]} min\n`;
      });

      document.getElementById('output').innerText = schedule;
    }
  </script>

</body>
</html>
